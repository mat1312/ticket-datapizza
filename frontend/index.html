<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¢ Ufficio Reclami Polo Nord</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Fredoka:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --santa-red: #DC2626;
            --santa-red-dark: #991B1B;
            --xmas-green: #16A34A;
            --xmas-green-dark: #166534;
            --gold: #FACC15;
            --snow: #F8FAFC;
            --night: #1E293B;
            --night-deep: #0F172A;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(180deg, #0F172A 0%, #1E3A5F 50%, #0F172A 100%);
            min-height: 100vh;
        }

        /* Snowfall */
        .snowfall {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            top: -20px;
            color: white;
            font-size: 1.2rem;
            animation: snowfall linear infinite;
            opacity: 0.8;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(-20px) rotate(0deg);
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Christmas Lights */
        .xmas-lights {
            display: flex;
            gap: 12px;
            padding: 8px 0;
        }

        .light-bulb {
            width: 12px;
            height: 18px;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: glow 1.5s ease-in-out infinite alternate;
            position: relative;
        }

        .light-bulb::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #555;
            border-radius: 2px;
        }

        .light-bulb.red {
            background: #EF4444;
            box-shadow: 0 0 20px #EF4444, 0 0 40px #EF444480;
        }

        .light-bulb.green {
            background: #22C55E;
            box-shadow: 0 0 20px #22C55E, 0 0 40px #22C55E80;
            animation-delay: 0.3s;
        }

        .light-bulb.gold {
            background: #FACC15;
            box-shadow: 0 0 20px #FACC15, 0 0 40px #FACC1580;
            animation-delay: 0.6s;
        }

        .light-bulb.blue {
            background: #3B82F6;
            box-shadow: 0 0 20px #3B82F6, 0 0 40px #3B82F680;
            animation-delay: 0.9s;
        }

        @keyframes glow {
            0% {
                opacity: 0.5;
                filter: brightness(0.7);
            }

            100% {
                opacity: 1;
                filter: brightness(1.3);
            }
        }

        /* Card Styles */
        .gift-card {
            background: linear-gradient(135deg, #FFFFFF10 0%, #FFFFFF05 100%);
            border: 2px solid #FFFFFF20;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .gift-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: var(--gold);
            box-shadow: 0 10px 40px rgba(250, 204, 21, 0.2);
        }

        /* Panel Styles */
        .north-pole-panel {
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
            border: 2px solid #334155;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Terminal */
        .magic-terminal {
            background: #0A0A0A;
            border: 2px solid #22C55E40;
            border-radius: 12px;
            font-family: 'Comic Neue', monospace;
        }

        .terminal-line {
            opacity: 0;
            animation: typeIn 0.3s ease forwards;
        }

        @keyframes typeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Big Button */
        .magic-button {
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
            border-radius: 16px;
            font-size: 1.25rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .magic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.6);
        }

        .magic-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Coal Alert */
        .coal-alert {
            animation: gentle-shake 2s ease-in-out infinite;
            background: linear-gradient(135deg, #92400E 0%, #78350F 100%);
            border: 2px solid #F97316;
        }

        @keyframes gentle-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-2px);
            }

            75% {
                transform: translateX(2px);
            }
        }

        /* Priority Badges */
        .badge-critical {
            background: #EF4444;
            animation: pulse 1s infinite;
        }

        .badge-high {
            background: #F97316;
        }

        .badge-medium {
            background: #22C55E;
        }

        /* Logs Modal */
        .logs-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .logs-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .logs-modal {
            width: 90vw;
            height: 85vh;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            border: 2px solid rgba(34, 197, 94, 0.4);
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(34, 197, 94, 0.15);
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .logs-modal-overlay.active .logs-modal {
            transform: scale(1);
        }

        .logs-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 28px;
            border-bottom: 1px solid rgba(34, 197, 94, 0.3);
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
        }

        .logs-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #22C55E;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .logs-modal-close {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #EF4444;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logs-modal-close:hover {
            background: rgba(239, 68, 68, 0.4);
            transform: scale(1.05);
        }

        .logs-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .expand-logs-btn {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.2) 100%);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22C55E;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .expand-logs-btn:hover {
            background: rgba(34, 197, 94, 0.3);
            transform: translateY(-1px);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Tool Card Animation */
        .tool-card {
            animation: slideIn 0.4s ease forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sidebar & Layout */
        .layout-container {
            display: flex;
            height: calc(100vh - 80px);
            /* Adjust based on header height */
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 350px;
            background: rgba(15, 23, 42, 0.95);
            border-right: 2px solid #334155;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 30;
        }

        .sidebar.collapsed {
            width: 0;
            border-right: none;
            overflow: hidden;
            opacity: 0;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
            background: rgba(15, 23, 42, 0.3);
            transition: all 0.3s ease;
        }

        .sidebar-toggle-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            z-index: 50;
            background: var(--night-deep);
            border: 2px solid #334155;
            color: #fff;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle-btn:hover {
            background: #334155;
            color: var(--gold);
        }

        /* Adjust scrollbar for sidebar */
        .sidebar {
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }

        /* ============================================
           üéÑ PREMIUM CUSTOM SCROLLBARS üéÑ
           ============================================ */

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(34, 197, 94, 0.5) rgba(15, 23, 42, 0.3);
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        *::-webkit-scrollbar-track {
            background: linear-gradient(to right, rgba(15, 23, 42, 0.3), rgba(30, 41, 59, 0.2));
            border-radius: 10px;
            margin: 4px;
        }

        *::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg,
                    rgba(34, 197, 94, 0.6) 0%,
                    rgba(22, 163, 74, 0.4) 50%,
                    rgba(250, 204, 21, 0.5) 100%);
            border-radius: 10px;
            border: 2px solid rgba(15, 23, 42, 0.4);
            box-shadow:
                0 0 10px rgba(34, 197, 94, 0.3),
                inset 0 0 6px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg,
                    rgba(34, 197, 94, 0.9) 0%,
                    rgba(250, 204, 21, 0.8) 50%,
                    rgba(239, 68, 68, 0.7) 100%);
            box-shadow:
                0 0 20px rgba(250, 204, 21, 0.6),
                0 0 30px rgba(34, 197, 94, 0.4),
                inset 0 0 10px rgba(255, 255, 255, 0.2);
            border-color: rgba(250, 204, 21, 0.3);
            transform: scaleX(1.1);
        }

        *::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg,
                    rgba(239, 68, 68, 0.9) 0%,
                    rgba(220, 38, 38, 0.8) 100%);
            box-shadow:
                0 0 25px rgba(239, 68, 68, 0.8),
                inset 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Corner (when both scrollbars exist) */
        *::-webkit-scrollbar-corner {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }

        /* Custom class for darker scrollbars (terminal, modals) */
        .custom-scrollbar::-webkit-scrollbar-track {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.5), rgba(10, 10, 10, 0.3));
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg,
                    rgba(34, 197, 94, 0.7) 0%,
                    rgba(59, 130, 246, 0.5) 100%);
            box-shadow:
                0 0 15px rgba(34, 197, 94, 0.5),
                0 0 8px rgba(59, 130, 246, 0.3);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg,
                    rgba(34, 197, 94, 1) 0%,
                    rgba(59, 130, 246, 0.8) 50%,
                    rgba(250, 204, 21, 0.9) 100%);
            box-shadow:
                0 0 25px rgba(34, 197, 94, 0.8),
                0 0 15px rgba(250, 204, 21, 0.6);
        }

        /* Sidebar specific scrollbar (red theme) */
        .sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg,
                    rgba(220, 38, 38, 0.6) 0%,
                    rgba(239, 68, 68, 0.5) 100%);
            box-shadow:
                0 0 10px rgba(220, 38, 38, 0.4),
                inset 0 0 6px rgba(255, 255, 255, 0.1);
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg,
                    rgba(220, 38, 38, 0.9) 0%,
                    rgba(250, 204, 21, 0.8) 100%);
            box-shadow:
                0 0 20px rgba(220, 38, 38, 0.7),
                0 0 15px rgba(250, 204, 21, 0.5);
        }

        /* Ticket list scrollbar (gold accent) */
        #ticketsList::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg,
                    rgba(250, 204, 21, 0.6) 0%,
                    rgba(34, 197, 94, 0.5) 100%);
        }

        #ticketsList::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg,
                    rgba(250, 204, 21, 0.9) 0%,
                    rgba(34, 197, 94, 0.8) 100%);
            box-shadow:
                0 0 20px rgba(250, 204, 21, 0.8),
                0 0 15px rgba(34, 197, 94, 0.5);
        }
    </style>
</head>

<body class="text-white overflow-x-hidden">

    <!-- Snowfall -->
    <div class="snowfall" id="snowfall"></div>

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-[#0F172A]/95 backdrop-blur-md border-b-2 border-[#334155] h-[80px]">
        <div class=" px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="toggleSidebar" class="p-2 hover:bg-slate-800 rounded-lg text-slate-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <span class="text-4xl">üè¢</span>
                <div>
                    <h1 class="text-2xl font-bold text-white leading-none">
                        Ufficio <span class="text-red-500">Reclami</span> Polo Nord
                    </h1>
                </div>
            </div>

            <div class="xmas-lights hidden md:flex">
                <div class="light-bulb red"></div>
                <div class="light-bulb green"></div>
                <div class="light-bulb gold"></div>
                <div class="light-bulb blue"></div>
                <div class="light-bulb red"></div>
                <div class="light-bulb green"></div>
                <div class="light-bulb gold"></div>
            </div>

            <div class="flex items-center gap-3 text-sm">
                <span class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-green-400 hidden sm:inline">Online</span>
                </span>
                <span class="text-slate-500 hidden sm:inline">|</span>
                <span class="text-slate-400">ü¶å Renne: Pronte</span>
            </div>
        </div>
    </header>

    <div class="layout-container" id="layoutContainer">

        <!-- SIDEBAR: Ticket List -->
        <aside class="sidebar p-4" id="sidebar">
            <div class="flex items-center gap-3 mb-6 px-2">
                <span class="text-2xl">üì¨</span>
                <h2 class="text-xl font-bold text-white">Richieste</h2>
                <div class="ml-auto text-xs text-slate-400 font-mono bg-slate-800 px-2 py-1 rounded">INCOMING</div>
            </div>

            <div id="ticketsList" class="space-y-3 overflow-y-auto flex-1 custom-scrollbar pr-2">
                <div class="text-slate-400 animate-pulse flex items-center gap-2 p-2">
                    <span class="text-xl">‚ùÑÔ∏è</span> Caricamento...
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-700 text-center text-xs text-slate-500">
                Santa's OS v24.12.25
            </div>
        </aside>

        <!-- MAIN: Content -->
        <main class="main-content p-6 custom-scrollbar relative">
            <div class="max-w-6xl mx-auto space-y-6">

                <!-- Active Ticket -->
                <div id="activeTicketPanel" class="hidden north-pole-panel p-6 animate-fade-in">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üé´</span>
                            <div>
                                <h3 id="ticketSubject" class="text-xl font-bold text-white">Oggetto</h3>
                                <div class="flex gap-3 text-sm text-slate-400 mt-1">
                                    <span id="ticketId" class="font-mono text-cyan-400">ID: ---</span>
                                    <span>‚Ä¢</span>
                                    <span id="ticketSender">Categoria: ---</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-700/50">
                        <p id="ticketMessage" class="text-slate-200 leading-relaxed font-sans text-lg">
                            Contenuto messaggio...
                        </p>
                    </div>

                    <!-- Image Upload -->
                    <div class="mb-6 p-4 bg-slate-900/40 rounded-xl border border-dashed border-slate-600">
                        <label
                            class="flex items-center gap-2 text-sm font-semibold text-slate-300 mb-2 cursor-pointer hover:text-white transition-colors">
                            <span>üìé</span> <span>Allega Immagine (opzionale)</span>
                        </label>
                        <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-slate-300
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-xl file:border-0
                            file:text-sm file:font-semibold
                            file:bg-slate-700 file:text-white
                            hover:file:bg-slate-600 cursor-pointer" />
                    </div>

                    <button id="generateBtn" onclick="generateResponse()"
                        class="w-full magic-button text-white py-4 px-6 flex items-center justify-center gap-3 hover:scale-[1.01] active:scale-[0.99]">
                        <span class="text-2xl">üìã</span>
                        <span>Elabora Reclamo</span>
                        <span class="text-2xl">üìã</span>
                    </button>
                </div>

                <!-- Placeholder when no ticket selected -->
                <div id="emptyState" class="flex flex-col items-center justify-center h-[50vh] text-slate-500">
                    <div class="text-6xl mb-4 opacity-50">üì¨</div>
                    <h3 class="text-xl font-bold text-slate-400">Seleziona un reclamo dalla lista</h3>
                    <p class="text-sm opacity-60">I genitori non scherzano quest'anno!</p>
                </div>

                <!-- Terminal / Tool Calls -->
                <div id="terminalOutput" class="hidden magic-terminal p-4 shadow-xl">
                    <div class="flex items-center gap-2 text-green-400 text-sm mb-3 pb-2 border-b border-green-900/50">
                        <div class="flex items-center gap-2 cursor-pointer hover:bg-slate-800/50 rounded-lg px-2 py-1 transition-colors flex-1"
                            onclick="toggleTerminalLogs()">
                            <span class="animate-pulse">üü¢</span>
                            <span class="font-bold font-mono">SYSTEM LOGS</span>
                            <div class="ml-auto flex gap-2 text-xs opacity-70">
                                <span>MEM: 64TB</span>
                                <span>CPU: 99%</span>
                                <span id="terminalToggleIcon">‚ñº</span>
                            </div>
                        </div>
                        <button onclick="openLogsModal()" class="expand-logs-btn" title="Espandi a tutto schermo">
                            <span>üì∫</span>
                            <span>Espandi</span>
                        </button>
                    </div>
                    <div id="terminalLogs"
                        class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar font-mono text-sm hidden">
                        <!-- Logs -->
                    </div>
                </div>

                <!-- Fullscreen Logs Modal -->
                <div id="logsModalOverlay" class="logs-modal-overlay" onclick="closeLogsModal(event)">
                    <div class="logs-modal" onclick="event.stopPropagation()">
                        <div class="logs-modal-header">
                            <div class="logs-modal-title">
                                <span class="text-3xl">üéÖ</span>
                                <span>Registro Elaborazione Reclami</span>
                                <span class="text-3xl">üîß</span>
                            </div>
                            <button class="logs-modal-close" onclick="closeLogsModal()">‚úï</button>
                        </div>
                        <div id="logsModalContent" class="logs-modal-content custom-scrollbar font-mono">
                            <!-- Logs will be cloned here -->
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div id="resultPanel" class="hidden space-y-6">

                    <!-- Main Response Panel -->
                    <div class="north-pole-panel p-6 border-l-4 border-l-yellow-500">
                        <div class="flex items-center justify-between gap-4 mb-4 flex-wrap">
                            <h4
                                class="flex items-center gap-2 text-yellow-400 font-bold text-lg uppercase tracking-wider">
                                <span class="text-2xl">üí¨</span> Risposta Suggerita
                            </h4>
                            <!-- Coal Alert (compact inline badge) -->
                            <div id="coalAlert"
                                class="hidden flex items-center gap-2 coal-alert rounded-xl px-4 py-2 text-center shadow-lg">
                                <div class="text-xl">ü™®</div>
                                <div class="text-xs font-bold text-orange-400 uppercase">Lista Cattivi Rilevata!</div>
                                <div class="text-xs text-orange-300">‚ö†Ô∏è Protocollo Carbone</div>
                            </div>
                        </div>
                        <div class="bg-black/20 p-5 rounded-lg mb-4">
                            <p id="finalResponse"
                                class="text-slate-100 text-base leading-relaxed whitespace-pre-wrap font-sans"></p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-3 mb-4">
                            <button onclick="sendResponse()"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl flex items-center justify-center gap-2 transition-all hover:scale-105 active:scale-95 shadow-lg">
                                <span class="text-xl">‚úâÔ∏è</span>
                                <span>Invia Risposta</span>
                            </button>
                            <button onclick="toggleRegenerateInput()"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl flex items-center justify-center gap-2 transition-all hover:scale-105 active:scale-95 shadow-lg">
                                <span class="text-xl">üîÑ</span>
                                <span>Rigenera</span>
                            </button>
                        </div>

                        <!-- Regenerate Feedback Section (hidden by default) -->
                        <div id="regenerateSection"
                            class="hidden bg-slate-900/50 p-4 rounded-lg border border-blue-500/30">
                            <label class="block text-blue-300 font-semibold mb-2 text-sm">
                                üí° Cosa non va? Fornisci istruzioni per rigenerare:
                            </label>
                            <textarea id="regenerateFeedback"
                                class="w-full bg-slate-800 text-white border border-slate-600 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                                rows="3"
                                placeholder="Es: Usa un tono pi√π formale, aggiungi pi√π dettagli tecnici, sii pi√π conciso..."></textarea>
                            <div class="flex gap-2 mt-3">
                                <button onclick="regenerateWithFeedback()"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                                    Rigenera con Feedback
                                </button>
                                <button onclick="toggleRegenerateInput()"
                                    class="bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold py-2 px-4 rounded-lg transition-all">
                                    Annulla
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Checklist (collapsible) -->
                    <details class="north-pole-panel border-l-4 border-l-green-500">
                        <summary class="cursor-pointer p-5 hover:bg-slate-800/50 rounded-t-lg transition-colors">
                            <h4
                                class="inline-flex items-center gap-2 text-green-400 font-bold uppercase tracking-wider">
                                <span class="text-xl">‚úÖ</span> Azioni da Fare
                            </h4>
                        </summary>
                        <div class="p-5 pt-0">
                            <ul id="actionChecklist" class="space-y-3">
                                <!-- Checkboxes -->
                            </ul>
                        </div>
                    </details>

                </div>

            </div>
        </main>
    </div>

    <script>
        // Create snowflakes
        function createSnow() {
            const container = document.getElementById('snowfall');
            const flakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úª', '‚úº'];

            for (let i = 0; i < 40; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.textContent = flakes[Math.floor(Math.random() * flakes.length)];
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDuration = (Math.random() * 5 + 8) + 's';
                flake.style.animationDelay = Math.random() * 8 + 's';
                flake.style.fontSize = (Math.random() * 1 + 0.6) + 'rem';
                flake.style.opacity = Math.random() * 0.5 + 0.3;
                container.appendChild(flake);
            }
        }
        const layoutContainer = document.getElementById('layoutContainer');
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');

        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        // Create snowflakes

        const API_BASE = window.location.origin + '/api';
        let currentTicket = null;
        let selectedImageBase64 = null;

        document.getElementById('imageInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    selectedImageBase64 = evt.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        async function loadTickets() {
            try {
                const res = await fetch(`${API_BASE}/tickets/examples`);
                const data = await res.json();
                renderTicketList(data.tickets);
            } catch (e) {
                console.error("Connessione fallita", e);
                document.getElementById('ticketsList').innerHTML =
                    '<div class="text-red-400">‚ùå Errore connessione</div>';
            }
        }

        function renderTicketList(tickets) {
            const container = document.getElementById('ticketsList');
            container.innerHTML = '';

            tickets.forEach(ticket => {
                const div = document.createElement('div');
                div.className = 'gift-card p-4 cursor-pointer';
                div.onclick = () => selectTicket(ticket);

                const priorityBadge = getPriorityBadge(ticket.priority);

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-semibold text-slate-400">${ticket.id}</span>
                        <span class="px-2 py-0.5 rounded-full text-[10px] font-bold text-white ${priorityBadge.class}">${priorityBadge.label}</span>
                    </div>
                    <div class="font-bold text-white mb-1 truncate">${ticket.subject}</div>
                    <div class="text-xs text-slate-400 truncate flex items-center gap-1">
                        <span>üìÅ</span> ${ticket.category}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function getPriorityBadge(p) {
            if (p === 'critical') return { class: 'badge-critical', label: 'CRITICO' };
            if (p === 'high') return { class: 'badge-high', label: 'ALTA' };
            return { class: 'badge-medium', label: 'MEDIA' };
        }

        function selectTicket(ticket) {
            currentTicket = ticket;
            selectedImageBase64 = null;
            document.getElementById('imageInput').value = "";
            document.getElementById('activeTicketPanel').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden'); // Hide placeholder
            document.getElementById('ticketSubject').innerText = ticket.subject;
            document.getElementById('ticketId').innerText = `ID: ${ticket.id}`;
            document.getElementById('ticketSender').innerText = `Categoria: ${ticket.category}`;
            document.getElementById('ticketMessage').innerText = ticket.message;

            // Reset UI
            document.getElementById('terminalOutput').classList.add('hidden');
            document.getElementById('resultPanel').classList.add('hidden');
            document.getElementById('coalAlert').classList.add('hidden');
            document.getElementById('terminalLogs').innerHTML = '';
            document.getElementById('terminalLogs').classList.add('hidden');
            document.getElementById('terminalToggleIcon').textContent = '‚ñº';
            document.getElementById('regenerateSection').classList.add('hidden');
            document.getElementById('regenerateFeedback').value = '';
        }

        // Toggle terminal logs visibility
        function toggleTerminalLogs() {
            const logs = document.getElementById('terminalLogs');
            const icon = document.getElementById('terminalToggleIcon');
            logs.classList.toggle('hidden');
            icon.textContent = logs.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        }

        // Toggle regenerate input section
        function toggleRegenerateInput() {
            const section = document.getElementById('regenerateSection');
            section.classList.toggle('hidden');
        }

        // Open fullscreen logs modal
        function openLogsModal() {
            const overlay = document.getElementById('logsModalOverlay');
            const modalContent = document.getElementById('logsModalContent');
            const terminalLogs = document.getElementById('terminalLogs');

            // Clone the current logs content to modal
            modalContent.innerHTML = terminalLogs.innerHTML;
            modalContent.scrollTop = modalContent.scrollHeight;

            // Show modal
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Use MutationObserver for smooth live sync - ONLY direct children
            // Use MutationObserver for smooth live sync
            window.logsModalObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    // Handle new nodes (additions) - ONLY for direct children of terminalLogs
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0 && mutation.target === terminalLogs) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Check if this node already exists in modal
                                const existingIds = [...modalContent.querySelectorAll('[id]')].map(el => el.id);
                                if (node.id && existingIds.includes(node.id)) return;

                                // Clone and append
                                const clone = node.cloneNode(true);
                                modalContent.appendChild(clone);
                                modalContent.scrollTo({ top: modalContent.scrollHeight, behavior: 'smooth' });
                            }
                        });
                    }

                    // Handle updates to existing nodes (subtree changes)
                    // We simply find the closest parent with an ID in the source, and re-sync it in the modal
                    let target = mutation.target;
                    while (target && target !== terminalLogs && !target.id) {
                        target = target.parentElement;
                    }

                    if (target && target.id && target !== terminalLogs) {
                        const modalNode = modalContent.querySelector(`[id="${target.id}"]`);
                        if (modalNode) {
                            // Sync content by replacing innerHTML
                            // This is safe because we just want a visual mirror
                            if (modalNode.innerHTML !== target.innerHTML || modalNode.className !== target.className) {
                                modalNode.className = target.className;
                                modalNode.innerHTML = target.innerHTML;
                            }
                        }
                    }
                });
            });

            // Observe subtree to catch updates inside cards
            window.logsModalObserver.observe(terminalLogs, {
                childList: true,
                subtree: true,
                attributes: true,
                characterData: true
            });
        }

        // Close fullscreen logs modal
        function closeLogsModal(event) {
            // If called with event, check if clicking overlay (not modal)
            if (event && event.target !== event.currentTarget) return;

            const overlay = document.getElementById('logsModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';

            // Disconnect the observer
            if (window.logsModalObserver) {
                window.logsModalObserver.disconnect();
                window.logsModalObserver = null;
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLogsModal();
        });

        // Send response (placeholder for now)
        function sendResponse() {
            alert('‚úÖ Risposta inviata! (Funzionalit√† placeholder)');
            // TODO: Implement actual send functionality
        }

        // Regenerate with feedback (placeholder for now)
        function regenerateWithFeedback() {
            const feedback = document.getElementById('regenerateFeedback').value.trim();
            if (!feedback) {
                alert('‚ö†Ô∏è Per favore, fornisci delle istruzioni per la rigenerazione.');
                return;
            }
            alert(`üîÑ Rigenerazione con feedback: "${feedback}"\n\n(Backend da implementare)`);
            // TODO: Call backend API with feedback to regenerate response
            document.getElementById('regenerateFeedback').value = '';
            toggleRegenerateInput();
        }

        // Simulate streaming with delay
        function addLogWithDelay(logsEl, html, delay) {
            return new Promise(resolve => {
                setTimeout(() => {
                    logsEl.innerHTML += html;
                    logsEl.parentElement.scrollTop = logsEl.parentElement.scrollHeight;
                    resolve();
                }, delay);
            });
        }

        // Handle SSE streaming events
        let logCounter = 0;  // Global counter for ALL unique log element IDs
        let pendingTools = {};  // Map tool_name to array of pending card IDs

        function handleStreamEvent(data, logsEl) {
            logCounter++;
            const logId = `log-${logCounter}`;

            const escapeHtml = (text) => {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            switch (data.type) {
                case 'connected':
                    // Reset on new connection (but keep logCounter for uniqueness)
                    pendingTools = {};
                    logsEl.innerHTML += `
                        <div class="terminal-line text-green-400 flex items-center gap-2" id="${logId}">
                            <span>üîå</span> ${escapeHtml(data.message)}
                        </div>
                    `;
                    break;

                case 'tool_start':
                    const toolEmoji = data.tool_name.includes('sql') || data.tool_name.includes('SQL') ? 'üóÑÔ∏è' :
                        data.tool_name.includes('schema') ? 'üìã' :
                            data.tool_name.includes('knowledge') || data.tool_name.includes('manual') ? 'üìö' :
                                data.tool_name.includes('ticket') ? 'üé´' : '‚öôÔ∏è';

                    // Track this pending tool
                    if (!pendingTools[data.tool_name]) {
                        pendingTools[data.tool_name] = [];
                    }
                    pendingTools[data.tool_name].push(logId);

                    logsEl.innerHTML += `
                        <div class="tool-card bg-slate-800/80 rounded-xl p-4 mt-3 border border-yellow-500/50" id="${logId}" data-tool-name="${escapeHtml(data.tool_name)}">
                            <div class="flex items-center justify-between mb-3">
                                <span class="flex items-center gap-2 text-white font-bold">
                                    <span class="text-xl">${toolEmoji}</span>
                                    ${escapeHtml(data.tool_name)}
                                </span>
                                <span class="tool-status text-yellow-400 font-semibold animate-pulse">‚è≥ In corso...</span>
                            </div>
                            <div class="text-sm">
                                <span class="text-slate-400">Input:</span>
                                <code class="ml-2 bg-slate-900 px-2 py-1 rounded text-blue-300">${escapeHtml(data.tool_input)}</code>
                            </div>
                        </div>
                    `;
                    break;

                case 'tool_complete':
                    const statusColor = data.status === 'success' ? 'text-green-400' : 'text-red-400';
                    const statusIcon = data.status === 'success' ? '‚úÖ' : '‚ùå';
                    const borderColor = data.status === 'success' ? 'border-green-500/50' : 'border-red-500/50';

                    // Find the first pending card for this tool
                    let cardId = null;
                    if (pendingTools[data.tool_name] && pendingTools[data.tool_name].length > 0) {
                        cardId = pendingTools[data.tool_name].shift();
                    }

                    const existingCard = cardId ? document.getElementById(cardId) : null;

                    if (existingCard) {
                        // Update existing card
                        existingCard.classList.remove('border-yellow-500/50');
                        existingCard.classList.add(borderColor);
                        const statusSpan = existingCard.querySelector('.tool-status');
                        if (statusSpan) {
                            statusSpan.className = `tool-status ${statusColor} font-semibold`;
                            statusSpan.innerHTML = statusIcon;
                        }

                        // Add output
                        const outputDiv = document.createElement('div');
                        outputDiv.className = 'text-sm mt-2';
                        outputDiv.innerHTML = `
                            <span class="text-slate-400">Output:</span>
                            <pre class="mt-1 bg-slate-900 p-2 rounded text-green-300 text-xs overflow-x-auto max-h-24">${escapeHtml(data.tool_output)}</pre>
                        `;
                        existingCard.appendChild(outputDiv);
                    } else {
                        // Fallback: Create new complete card
                        const completeEmoji = data.tool_name.includes('sql') ? 'üóÑÔ∏è' : data.tool_name.includes('schema') ? 'üìã' : 'üìö';
                        logsEl.innerHTML += `
                            <div class="tool-card bg-slate-800/80 rounded-xl p-4 mt-3 border ${borderColor}">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="flex items-center gap-2 text-white font-bold">
                                        <span class="text-xl">${completeEmoji}</span>
                                        ${escapeHtml(data.tool_name)}
                                    </span>
                                    <span class="${statusColor} font-semibold">${statusIcon}</span>
                                </div>
                                <div class="text-sm mb-2">
                                    <span class="text-slate-400">Input:</span>
                                    <code class="ml-2 bg-slate-900 px-2 py-1 rounded text-blue-300">${escapeHtml(data.tool_input)}</code>
                                </div>
                                <div class="text-sm">
                                    <span class="text-slate-400">Output:</span>
                                    <pre class="mt-1 bg-slate-900 p-2 rounded text-green-300 text-xs overflow-x-auto max-h-24">${escapeHtml(data.tool_output)}</pre>
                                </div>
                            </div>
                        `;
                    }
                    break;

                case 'thought':
                    logsEl.innerHTML += `
                        <div class="terminal-line text-cyan-400 ml-4 text-sm flex items-center gap-2" id="${logId}">
                            <span>üß†</span> ${escapeHtml(data.content.substring(0, 150))}...
                        </div>
                    `;
                    break;

                case 'step':
                    logsEl.innerHTML += `
                        <div class="terminal-line text-purple-400 text-sm flex items-center gap-2 mt-2" id="${logId}">
                            <span>üìç</span> ${escapeHtml(data.message)}
                        </div>
                    `;
                    break;

                case 'error':
                    logsEl.innerHTML += `
                        <div class="terminal-line text-red-400 mt-2 flex items-center gap-2" id="${logId}">
                            <span>‚ùå</span> Errore: ${escapeHtml(data.message)}
                        </div>
                    `;
                    break;
            }

            // Auto-scroll
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        async function generateResponse() {
            if (!currentTicket) return;

            const btn = document.getElementById('generateBtn');
            btn.innerHTML = '<span class="animate-spin">üîÑ</span> Santa sta pensando...';
            btn.disabled = true;

            const terminal = document.getElementById('terminalOutput');
            const logs = document.getElementById('terminalLogs');
            terminal.classList.remove('hidden');
            logs.classList.remove('hidden'); // Show logs by default for streaming
            logs.innerHTML = '';
            document.getElementById('terminalToggleIcon').textContent = '‚ñ≤';

            try {
                const payload = {
                    ticket: currentTicket,
                    image_base64: selectedImageBase64 ? selectedImageBase64.split(',')[1] : null
                };

                // Use streaming fetch for SSE
                const response = await fetch(`${API_BASE}/tickets/generate-response-stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalResponse = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Parse SSE format: "data: {...}\n\n"
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleStreamEvent(data, logs);

                                if (data.type === 'complete') {
                                    finalResponse = data.response;
                                }
                            } catch (parseErr) {
                                console.warn('SSE parse error:', parseErr, line);
                            }
                        }
                    }
                }

                // Handle final response
                if (finalResponse) {
                    document.getElementById('resultPanel').classList.remove('hidden');

                    // Coal Alert
                    if (finalResponse.coal_alert) {
                        document.getElementById('coalAlert').classList.remove('hidden');
                    } else {
                        document.getElementById('coalAlert').classList.add('hidden');
                    }

                    // Action Checklist
                    const checklist = document.getElementById('actionChecklist');
                    checklist.innerHTML = '';
                    (finalResponse.action_checklist || []).forEach(action => {
                        const li = document.createElement('li');
                        li.className = "flex items-start gap-3 text-slate-200";
                        li.innerHTML = `
                            <input type="checkbox" class="mt-1 w-5 h-5 accent-green-500 rounded">
                            <span class="text-sm">${action}</span>
                        `;
                        checklist.appendChild(li);
                    });

                    // Final Response
                    document.getElementById('finalResponse').innerText = finalResponse.suggested_response;

                    // Add completion log
                    logs.innerHTML += `
                        <div class="terminal-line text-green-400 mt-4 flex items-center gap-2 font-bold">
                            <span>‚úÖ</span> Analisi completata!
                        </div>
                    `;
                }

            } catch (e) {
                console.error('Streaming error:', e);
                logs.innerHTML += `
                    <div class="terminal-line text-red-400 mt-2 flex items-center gap-2">
                        <span>‚ùå</span> Errore: ${e.message}
                    </div>
                `;
            } finally {
                btn.innerHTML = `
                    <span class="text-2xl">üéÑ</span>
                    <span>Chiedi a Santa AI</span>
                    <span class="text-2xl">üéÑ</span>
                `;
                btn.disabled = false;
            }
        }

        loadTickets();
    </script>

    <script>
        // Override regenerateWithFeedback with full implementation
        window.regenerateWithFeedback = async function () {
            const feedback = document.getElementById('regenerateFeedback').value.trim();
            if (!feedback) {
                alert('‚ö†Ô∏è Per favore, fornisci delle istruzioni per la rigenerazione.');
                return;
            }

            if (!currentTicket) {
                alert('‚ö†Ô∏è Nessun ticket selezionato');
                return;
            }

            toggleRegenerateInput();
            const btn = document.getElementById('generateBtn');
            btn.innerHTML = '<span class="animate-spin">üîÑ</span> Rigenerazione in corso...';
            btn.disabled = true;

            const terminal = document.getElementById('terminalOutput');
            const logs = document.getElementById('terminalLogs');
            terminal.classList.remove('hidden');
            logs.innerHTML = '';

            await addLogWithDelay(logs, '<div class="terminal-line text-blue-400 flex items-center gap-2"><span>üîÑ</span> Rigenerazione con feedback utente...</div>', 100);

            try {
                const payload = {
                    ticket: currentTicket,
                    image_base64: selectedImageBase64 ? selectedImageBase64.split(',')[1] : null,
                    regeneration_feedback: feedback
                };

                const res = await fetch(`${API_BASE}/tickets/generate-response`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.tool_calls && data.tool_calls.length > 0) {
                    await addLogWithDelay(logs, '<div class="terminal-line text-yellow-400 font-bold mt-3 text-lg flex items-center gap-2"><span>üîß</span> Tool Eseguiti:</div>', 300);

                    for (const tc of data.tool_calls) {
                        const statusColor = tc.status === 'success' ? 'text-green-400' : 'text-red-400';
                        const statusIcon = tc.status === 'success' ? '‚úÖ' : '‚ùå';
                        const toolEmoji = tc.tool_name.includes('sql') ? 'üóÑÔ∏è' : tc.tool_name.includes('schema') ? 'üìã' : 'üìö';

                        const escapeHtml = (text) => {
                            if (!text) return '';
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };

                        await addLogWithDelay(logs, `<div class="tool-card bg-slate-800/80 rounded-xl p-4 mt-3 border border-slate-600"><div class="flex items-center justify-between mb-3"><span class="flex items-center gap-2 text-white font-bold"><span class="text-xl">${toolEmoji}</span>${tc.tool_name}</span><span class="${statusColor} font-semibold">${statusIcon}</span></div><div class="text-sm mb-2"><span class="text-slate-400">Input:</span><code class="ml-2 bg-slate-900 px-2 py-1 rounded text-blue-300">${escapeHtml(tc.tool_input)}</code></div><div class="text-sm"><span class="text-slate-400">Output:</span><pre class="mt-1 bg-slate-900 p-2 rounded text-green-300 text-xs overflow-x-auto max-h-24">${escapeHtml(tc.tool_output)}</pre></div></div>`, 400);
                    }
                }

                const thoughts = data.thought_process.split('\n').filter(l => l.trim());
                for (const line of thoughts.slice(0, 5)) {
                    await addLogWithDelay(logs, `<div class="terminal-line text-slate-300 ml-6 text-sm">‚Üí ${line}</div>`, 150);
                }

                if (data.coal_alert) {
                    document.getElementById('coalAlert').classList.remove('hidden');
                } else {
                    document.getElementById('coalAlert').classList.add('hidden');
                }

                document.getElementById('finalResponse').innerText = data.suggested_response;

                const checklist = document.getElementById('actionChecklist');
                checklist.innerHTML = '';
                data.action_checklist.forEach(action => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start gap-3 bg-slate-800/50 p-3 rounded-lg border border-green-900/30';
                    li.innerHTML = `<input type="checkbox" class="mt-1 w-4 h-4 text-green-500 bg-slate-700 border-slate-600 rounded focus:ring-2 focus:ring-green-500" /><span class="text-slate-200">${action}</span>`;
                    checklist.appendChild(li);
                });

                document.getElementById('regenerateFeedback').value = '';
                btn.innerHTML = '<span class="text-2xl">üéÑ</span> <span>Chiedi a Santa AI</span> <span class="text-2xl">üéÑ</span>';
                btn.disabled = false;

            } catch (e) {
                console.error('Errore rigenerazione:', e);
                alert('‚ùå Errore durante la rigenerazione. Riprova.');
                btn.innerHTML = '<span class="text-2xl">üéÑ</span> <span>Chiedi a Santa AI</span> <span class="text-2xl">üéÑ</span>';
                btn.disabled = false;
            }
        };
    </script>
</body>

</html>